<div
  *ngIf="currentUserIsAdmin"
  class="mb-4 align-items-center d-flex flex-row justify-content-end"
>
  <button
    cButton
    class="float-end mb-1 z-index-2"
    variant="ghost"
    size="lg"
    color="dark"
    (click)="addProduct()"
  >
    <svg cIcon name="cil-playlist-add" size="lg" class="me-2"></svg>Add product
  </button>
</div>

<div *ngIf="showProductsInCategoriesSwitcherTEMPLATE" class="mb-4">
  <c-form-check
    inline="true"
    [switch]="true"
    class="align-items-center d-flex flex-row justify-content-end"
  >
    <input
      cFormCheckInput
      type="checkbox"
      checked
      id="showProductsInCategories"
      (click)="showProductsAll()"
    />
    <label class="ms-1" cFormCheckLabel>Show products in categories</label>
  </c-form-check>
</div>

<div *ngIf="showCategoriesTEMPLATE">
  <div *ngIf="categories$ | async as categories; else loader">
    <div *ngIf="categories.length !== 0">
      <c-row [gutter]="2" class="mb-2" [lg]="6" [md]="4" [xs]="1">
        <c-card *ngFor="let category of categories" class="mx-1">
          <div
            *ngIf="category._id"
            href="javascript:void(0);"
            (click)="showProductsByCategory(category._id, category.name)"
            style="cursor: pointer"
          >
            <img cCardImg="top" [src]="category.imageSrc" />
            <c-card-body>
              <h2 cCardTitle>{{ category.name }}</h2>
            </c-card-body>
          </div>
          <button
            *ngIf="currentUserIsAdmin"
            cButton
            type="button"
            size="sm"
            class="float-end mb-1 z-index-2"
            variant="ghost"
            color="dark"
            (click)="editCategory(category)"
          >
            <svg cIcon name="cil-pencil" size="lg" class="me-2"></svg>
            Edit category
          </button></c-card
        >
      </c-row>
    </div>
  </div>
</div>

<ng-container
  *ngIf="!showCategoriesTEMPLATE && !showProductsInCategoriesSwitcherTEMPLATE"
>
  <ng-container
    *ngTemplateOutlet="
      ProductsByCategoryTEMPLATE;
      context: {
        categoryId: selectedCategoryId,
        categoryName: selectedCategoryName
      }
    "
  ></ng-container>
</ng-container>

<ng-container
  *ngIf="!showCategoriesTEMPLATE && !showProductsByCategoryTEMPLATE"
>
  <ng-container *ngTemplateOutlet="ProductsAllTEMPLATE"></ng-container
></ng-container>

<div>
  <ng-template
    #ProductsByCategoryTEMPLATE
    let-categoryId="categoryId"
    let-categoryName="categoryName"
  >
    <div *ngIf="!fetchingProducts; else loader">
      <ng-container *ngIf="productsInCategories.length !== 0"
        ><span
          ><h3>{{ categoryName }}</h3></span
        ><button
          cButton
          class="mb-3 d-flex align-items-center justify-content-center"
          color="dark"
          variant="ghost"
          (click)="returnToCategories()"
        >
          <svg cIcon name="cil-arrow-circle-left" size="lg" class="me-2"></svg>
          Back to categories
        </button>

        <c-card class="mb-3 w-100" *ngFor="let product of productsInCategories">
          <c-row class="g-0">
            <c-col [md]="2">
              <img [cCardImg] [src]="product.imageSrc" [alt]="product.name" />
            </c-col>
            <c-card-body cCol [md]="8">
              <h5 cCardTitle>{{ product.name }}</h5>

              <p
                cCardText
                #ellipsisText
                class="text-truncate"
                style="max-width: w-100"
                [class.text-untruncate]="product.isDescriptionTrancated"
                (click)="textTruncate(product)"
              >
                {{ product.description }}
              </p>

              <p cCardText *ngIf="product.unit">
                <small class="text-medium-emphasis"
                  >Unit of measurement:
                  <strong>{{ product.unit }}</strong></small
                >
              </p> </c-card-body
            ><c-col
              [md]="1"
              class="align-items-center d-flex flex-column justify-content-center"
              ><h6>{{ product.cost | currency : "EUR" }}</h6></c-col
            ><c-col
              *ngIf="currentUserIsAdmin"
              [md]="1"
              class="align-items-center d-flex flex-column justify-content-center"
              ><button
                cButton
                size="sm"
                color="dark"
                (click)="editProduct(product._id ? product._id : '')"
              >
                <svg cIcon name="cil-pencil" size="lg" class="me-2"></svg>
                Edit product
              </button></c-col
            ><c-col
              *ngIf="!currentUserIsAdmin"
              [md]="1"
              class="align-items-center d-flex flex-column justify-content-center"
            >
              <input
                [(ngModel)]="product.quantity"
                cformControl
                type="number"
                class="mb-1 w-75 text-center small"
                min="1"
                value="1"
              />
              <button
                [disabled]="!product.quantity"
                cButton
                size="sm"
                color="dark"
                (click)="addToCart(product, currentUserId)"
              >
                Add to cart
              </button></c-col
            >
          </c-row>
        </c-card>
      </ng-container>
      <ng-container
        *ngIf="!productsInCategories || productsInCategories.length === 0"
        ><a href="javascript:void(0);" (click)="returnToCategories()"
          >Back to categories</a
        >
        <p>No products available for this category.</p>
      </ng-container>
    </div>
  </ng-template>
</div>

<div>
  <ng-template #ProductsAllTEMPLATE
    ><div *ngIf="!fetchingProducts; else loader">
      <ng-container *ngIf="productsAll.length !== 0">
        <c-card class="mb-3 w-100" *ngFor="let product of productsAll">
          <c-row class="g-0">
            <c-col [md]="2">
              <img [cCardImg] [src]="product.imageSrc" [alt]="product.name" />
            </c-col>
            <c-card-body cCol [md]="8">
              <h5 cCardTitle>{{ product.name }}</h5>
              <strong>{{ product.categoryName }}</strong>
              <p
                cCardText
                #ellipsisText
                class="text-truncate"
                style="max-width: w-100"
                [class.text-untruncate]="product.isDescriptionTrancated"
                (click)="textTruncate(product)"
              >
                {{ product.description }}
              </p>
              <p cCardText *ngIf="product.unit">
                <small class="text-medium-emphasis"
                  >Unit of measurement:
                  <strong>{{ product.unit }}</strong></small
                >
              </p> </c-card-body
            ><c-col
              [md]="1"
              class="align-items-center d-flex flex-column justify-content-center"
              ><h6>{{ product.cost | currency : "EUR" }}</h6></c-col
            ><c-col
              *ngIf="currentUserIsAdmin"
              [md]="1"
              class="align-items-center d-flex flex-column justify-content-center"
              ><button
                cButton
                size="sm"
                color="dark"
                (click)="editProduct(product._id ? product._id : '')"
              >
                <svg cIcon name="cil-pencil" size="lg" class="me-2"></svg>
                Edit product
              </button></c-col
            ><c-col
              *ngIf="!currentUserIsAdmin"
              [md]="1"
              class="align-items-center d-flex flex-column justify-content-center"
            >
              <input
                cformControl
                [(ngModel)]="product.quantity"
                type="number"
                class="mb-1 w-75 text-center small"
                min="1"
                value="1"
              />
              <button
                cButton
                size="sm"
                color="dark"
                (click)="addToCart(product, currentUserId)"
                [disabled]="!product.quantity"
              >
                Add to cart
              </button></c-col
            >
          </c-row>
        </c-card>
      </ng-container>
      <ng-container *ngIf="!productsAll || productsAll.length === 0">
        <p>No products available.</p>
      </ng-container>
    </div>
  </ng-template>
</div>

<ng-template #loader>
  <div class="myspinner">
    <c-spinner></c-spinner>
  </div>
</ng-template>

<c-modal
  [visible]="modalEditCategoryVisible"
  (visibleChange)="modalEditCategoryVisible = $event"
  backdrop="static"
  id="modalEditCategory"
  #modalEditCategory
  ><div *ngIf="selectedCategory">
    <form
      cForm
      novalidate
      [formGroup]="formEditCategory"
      (ngSubmit)="onSubmitEditCategory()"
    >
      <c-modal-header
        ><h4 cModalTitle>
          Edit category <strong>{{ selectedCategory.name }}</strong>
        </h4></c-modal-header
      ><c-modal-body
        ><c-row class="mb-3"
          ><label cCol cLabel for="categoryName">Category name</label
          ><c-col
            ><input
              [valid]="
                formEditCategory.get('categoryName').touched &&
                formEditCategory.get('categoryName').valid
                  ? true
                  : formEditCategory.get('categoryName').touched &&
                    formEditCategory.get('categoryName').invalid
                  ? false
                  : undefined
              "
              autocomplete="off"
              cFormControl
              id="categoryName"
              type="text"
              formControlName="categoryName"
            /><c-form-feedback
              class="text-end"
              *ngIf="formEditCategory.get('categoryName').invalid"
              [valid]="!formEditCategory.get('categoryName').invalid"
              ><ng-container
                *ngIf="
                  formEditCategory.get('categoryName').touched &&
                  formEditCategory.get('categoryName').invalid
                "
                ><div
                  *ngIf="
                    formEditCategory.get('categoryName').errors['required']
                  "
                >
                  Category name is required
                </div>
                <div
                  *ngIf="
                    formEditCategory.get('categoryName').errors['minlength'] &&
                    formEditCategory.get('categoryName').errors['minlength'][
                      'requiredLength'
                    ]
                  "
                >
                  Category name must be at least
                  {{
                    formEditCategory.get("categoryName").errors["minlength"][
                      "requiredLength"
                    ]
                  }}
                  characters long
                </div></ng-container
              ></c-form-feedback
            ></c-col
          ></c-row
        ><c-row
          ><c-col class="d-flex align-items-center justify-content-center"
            ><img
              class="w-50 mb-3"
              *ngIf="imagePreview"
              [src]="imagePreview" /></c-col
          ><input
            style="display: none"
            type="file"
            (change)="onFileUpload($event)"
            #fileInput
          /><button
            class="d-flex align-items-center justify-content-center"
            cButton
            variant="outline"
            color="info"
            (click)="triggerClick()"
            [disabled]="formEditCategory.disabled"
          >
            <svg cIcon name="cil-cloud-upload" size="lg" class="me-2"></svg>
            Upload image
          </button></c-row
        ></c-modal-body
      ><c-modal-footer
        ><button
          cButton
          [disabled]="formEditCategory.invalid || formEditCategory.disabled"
          color="primary"
          variant="outline"
          type="submit"
          size="sm"
          class="mb-3 d-flex align-items-center justify-content-center"
        >
          <svg cIcon name="cil-save" size="lg" class="me-2"></svg>
          Save
        </button>
        <button
          (click)="toggleModalEditCategory()"
          cButton
          color="secondary"
          variant="outline"
          size="sm"
          class="mb-3 d-flex align-items-center justify-content-center"
        >
          <svg cIcon name="cil-x-circle" size="lg" class="me-2"></svg>
          Cancel
        </button>
      </c-modal-footer>
    </form>
  </div></c-modal
>
